language: ruby
cache: bundler
services:
  - docker

before_install:
  - git clone https://github.com/tfutils/tfenv.git ~/.tfenv
  - export PATH="$HOME/.tfenv/bin:$PATH"
  - tfenv install $TFVER
  - terraform --version
  - gem update --system
  - gem install bundler
  - git --version

jobs:
  include:
    - rvm: 2.4
      env: TFVER=0.11.7
      script: bundle exec rspec spec
    - rvm: 2.4
      env: TFVER=latest
      script: bundle exec rspec spec
    - rvm: 2.6
      env: TFVER=0.11.7
      script: bundle exec rspec spec
    - rvm: 2.6
      env: TFVER=latest
      script: bundle exec rspec spec
    - stage: deploy
      before_deploy:
          - docker --version
          - docker build -t atmos:latest .
      deploy:
        - provider: script
          # Deploy the 'dev' tag on all master pushes
          script: bash bin/deploy.sh atmos:latest simplygenius/atmos dev
          on:
            branch: master
        - provider: script
          # Deploy the 'latest' and '<git_tag>' tag on all tagged pushes
          script: bash bin/deploy.sh atmos:latest simplygenius/atmos latest "${TRAVIS_TAG}"
          on:
            tags: true
