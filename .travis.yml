sudo: false
language: ruby
cache: bundler
services:
  - docker

rvm:
  - 2.3
  - 2.4
  - 2.5
  - 2.6

before_install:
  - gem update --system
  - gem install bundler
  - curl -sL https://releases.hashicorp.com/terraform/0.11.7/terraform_0.11.7_linux_amd64.zip > terraform.zip
  - unzip terraform.zip
  - mv terraform bin/
  - export PATH=$PATH:$PWD/bin/
  - terraform --version
  - git --version

script: bundle exec rspec spec

before_deploy:
  - docker --version
  - docker build -t atmos:latest .

deploy:
  - provider: script
    # Deploy the 'dev' tag on all master pushes
    script: bash bin/deploy.sh atmos:latest simplygenius/atmos dev
    on:
      branch: master
  - provider: script
    # Deploy the 'latest' and '<git_tag>' tag on all tagged pushes
    script: bash bin/deploy.sh atmos:latest simplygenius/atmos latest "${TRAVIS_TAG}"
    on:
      tags: true
