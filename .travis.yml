language: ruby
cache: bundler
services:
  - docker

before_install:
  - git clone https://github.com/tfutils/tfenv.git ~/.tfenv
  - export PATH="$HOME/.tfenv/bin:$PATH"
  - tfenv install $TFVER
  - tfenv use $TFVER
  - terraform --version
  - gem update --system
  - gem install bundler
  - git --version

rvm:
  - 2.5
  - 2.6
  - 2.7

env:
  - TFVER=0.11.14
  - TFVER=0.12.29
  - TFVER=latest

script: bundle exec rspec spec

jobs:
  include:
    - stage: deploy
      before_deploy:
          - docker --version
          - docker build -t atmos:latest .
      deploy:
        - provider: script
          # Deploy the 'dev' tag on all master pushes
          script: bash bin/deploy.sh atmos:latest simplygenius/atmos dev
          on:
            branch: master
        - provider: script
          # Deploy the 'latest' and '<git_tag>' tag on all tagged pushes
          script: bash bin/deploy.sh atmos:latest simplygenius/atmos latest "${TRAVIS_TAG}"
          on:
            tags: true
